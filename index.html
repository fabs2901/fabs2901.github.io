<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalender Abstimmungen</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    table, th, td {
      border: 1px solid black;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
    .color-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
    }
  </style>
</head>
<body>
  <h1>Kalender Abstimmungen</h1>
  
  <label for="username">Dein Name:</label>
  <input type="text" id="username" placeholder="Gib deinen Namen ein">
  <button id="submit-name">Abstimmung starten</button>
  
  <div id="calendar-container">
    <!-- Hier wird der Kalender dynamisch eingefügt -->
  </div>

  <h2>Abstimmungstabelle:</h2>
  <table id="user-table">
    <thead>
      <tr>
        <th>Tag</th>
        <!-- Dynamische Spalten für die User werden hier hinzugefügt -->
      </tr>
    </thead>
    <tbody>
      <!-- Dynamische Zeilen für die Tage werden hier hinzugefügt -->
    </tbody>
  </table>

  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
  <script>
    // Deine Firebase-Konfiguration
    const firebaseConfig = {
      apiKey: "dein-api-key",
      authDomain: "dein-auth-domain",
      databaseURL: "deine-database-url",
      projectId: "dein-projekt-id",
      storageBucket: "dein-storage-bucket",
      messagingSenderId: "dein-sender-id",
      appId: "deine-app-id"
    };

    // Firebase initialisieren
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Referenz auf den "abstimmungen"-Pfad in der Firebase-Datenbank
    const abstimmungenRef = db.ref('abstimmungen');

    const usernameInput = document.getElementById('username');
    const submitButton = document.getElementById('submit-name');
    const calendarContainer = document.getElementById('calendar-container');

    // Monat Namen
    const monthNames = {
      "juni": "Juni",
      "juli": "Juli"
    };

    let userColor = null;  // Variable für die Benutzerfarbe
    let userName = '';  // Variable für den Benutzernamen

    // Dynamisch die Tabelle und den Kalender erstellen
    function createCalendar() {
      const months = ["juni", "juli"];
      let calendarHTML = '';
      months.forEach(month => {
        calendarHTML += `<h3>${monthNames[month]}</h3><div class="calendar-month" id="${month}">`;
        for (let day = 1; day <= (month === "juni" ? 30 : 31); day++) {
          calendarHTML += `<button class="day" data-month="${month}" data-day="${day}">${day}</button>`;
        }
        calendarHTML += `</div>`;
      });
      calendarContainer.innerHTML = calendarHTML;

      // Event Listener für die Tage
      const dayButtons = document.querySelectorAll('.day');
      dayButtons.forEach(button => {
        button.addEventListener('click', function () {
          if (userName) {
            const month = button.getAttribute('data-month');
            const day = button.getAttribute('data-day');
            const color = userColor;

            // Daten in Firebase speichern
            const dayRef = abstimmungenRef.child(`${month}/${day}`);
            dayRef.child(userName).set(color);

            alert(`Du hast den ${day}. ${monthNames[month]} abgestimmt.`);
          } else {
            alert('Bitte gib zuerst deinen Namen ein!');
          }
        });
      });
    }

    // Funktion zum Erstellen der User-Tabelle
    function updateUserTable(data) {
      const userMap = {}; // Speichert alle User und deren Auswahl

      // Schritt 1: Alle User und ihre Farben/Daten sammeln
      for (const [month, days] of Object.entries(data)) {
        for (const [day, users] of Object.entries(days)) {
          for (const [user, color] of Object.entries(users)) {
            if (!userMap[user]) userMap[user] = {};
            userMap[user][`${day}. ${monthNames[month]}`] = color;
          }
        }
      }

      const tableBody = document.querySelector("#user-table tbody");
      tableBody.innerHTML = "";  // Vorherige Tabelle löschen

      // Schritt 2: Alle Tage (Zeilen) erstellen
      const allDays = getAllDays(data);
      const allUsers = Object.keys(userMap); // Alle User sammeln, um dynamisch Spalten zu erzeugen
      const tableHeader = document.querySelector("#user-table thead tr");
      tableHeader.innerHTML = "<th>Tag</th>";  // Reset der Header-Zeilen

      // Dynamisch Spalten für User hinzufügen
      allUsers.forEach(user => {
        const headerCell = document.createElement("th");
        headerCell.textContent = user;
        tableHeader.appendChild(headerCell);
      });

      // Schritt 3: Zeilen für die Tage erstellen
      allDays.forEach((day) => {
        const row = document.createElement("tr");

        // Tag als erste Spalte
        const dayCell = document.createElement("td");
        dayCell.textContent = day;
        row.appendChild(dayCell);

        // Spalten für jeden User hinzufügen
        allUsers.forEach(user => {
          const cell = document.createElement("td");

          // Falls der User diesen Tag gewählt hat, die Farbe anzeigen
          if (userMap[user][day]) {
            const colorDot = document.createElement("div");
            colorDot.style.width = "20px";
            colorDot.style.height = "20px";
            colorDot.style.borderRadius = "50%";
            colorDot.style.backgroundColor = userMap[user][day];
            cell.appendChild(colorDot);
          }
          row.appendChild(cell);
        });

        tableBody.appendChild(row);
      });
    }

    // Holen der Liste aller Tage aus den Daten
    function getAllDays(data) {
      const daysSet = new Set();
      for (const [month, days] of Object.entries(data)) {
        for (const [day] of Object.entries(days)) {
          daysSet.add(`${day}. ${monthNames[month]}`);
        }
      }
      return Array.from(daysSet);
    }

    // Wenn der Benutzer seinen Namen eingibt, dann:
    submitButton.addEventListener('click', function () {
      userName = usernameInput.value;
      if (userName) {
        userColor = getRandomColor();  // Zufällige Farbe für den User
        alert(`Willkommen, ${userName}! Deine Farbe ist ${userColor}`);
      } else {
        alert('Bitte gib deinen Namen ein!');
      }
    });

    // Funktion für zufällige Farben
    function getRandomColor() {
      const colors = ["#FF6347", "#4682B4", "#32CD32", "#FFD700", "#8A2BE2", "#FF1493"];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // Initiales Abrufen der Daten und bei Änderungen die Tabelle aktualisieren
    abstimmungenRef.on("value", function(snapshot) {
      const data = snapshot.val() || {};  // Wenn keine Daten vorhanden, leeres Objekt
      updateUserTable(data);  // Tabelle aktualisieren
    });

    // Initialisiere den Kalender
    createCalendar();

  </script>
</body>
</html>
