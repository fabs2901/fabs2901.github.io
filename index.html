<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Abstimmungskalender Juni & Juli</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    h1, h2 {
      text-align: center;
    }
    #nameInput {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px;
      font-size: 16px;
      text-align: center;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      max-width: 600px;
      margin: 0 auto 40px auto;
    }
    .day {
      background-color: white;
      border: 1px solid #ccc;
      padding: 15px 5px;
      text-align: center;
      min-height: 60px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .color-dots {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 3px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
  </style>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBqgDbdrNeyZmgpqvYsjrRXR6C5jwCNWsU",
      authDomain: "kalenderapp-bd072.firebaseapp.com",
      databaseURL: "https://kalenderapp-bd072-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kalenderapp-bd072",
      storageBucket: "kalenderapp-bd072.firebasestorage.app",
      messagingSenderId: "173720245818",
      appId: "1:173720245818:web:ba16e0ae3908d8ae630703"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let username = "";
    let userColor = "";

    function getRandomColor() {
      const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#1abc9c', '#e67e22', '#95a5a6'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    function createCalendar(monthId, monthName, daysInMonth) {
      const container = document.getElementById("calendars");
      const title = document.createElement("h2");
      title.textContent = monthName;
      container.appendChild(title);

      const grid = document.createElement("div");
      grid.classList.add("calendar");
      grid.id = `calendar-${monthId}`;
      container.appendChild(grid);

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div");
        cell.classList.add("day");
        cell.id = `${monthId}-day-${day}`;
        cell.innerHTML = `${day}<div class="color-dots" id="${monthId}-dots-${day}"></div>`;

        cell.addEventListener("click", () => {
          if (!username) {
            alert("Bitte gib zuerst deinen Namen ein.");
            return;
          }
          const dayRef = ref(db, `abstimmungen/${monthId}/${day}/${username}`);
          get(dayRef).then((snap) => {
            if (snap.exists()) {
              set(dayRef, null); // Entfernen
            } else {
              set(dayRef, userColor); // Hinzufügen
            }
          });
        });

        grid.appendChild(cell);
      }

      // Listener
      const monthRef = ref(db, `abstimmungen/${monthId}`);
      onValue(monthRef, (snapshot) => {
        const data = snapshot.val() || {};
        for (let day = 1; day <= daysInMonth; day++) {
          const dotContainer = document.getElementById(`${monthId}-dots-${day}`);
          dotContainer.innerHTML = ""; // clear
          if (data[day]) {
            Object.entries(data[day]).forEach(([user, color]) => {
              const dot = document.createElement("div");
              dot.classList.add("dot");
              dot.style.backgroundColor = color;
              dot.title = user;
              dotContainer.appendChild(dot);
            });
          }
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Name-Eingabe
      const nameInput = document.getElementById("nameInput");
      nameInput.addEventListener("change", () => {
        username = nameInput.value.trim().toLowerCase();
        if (username) {
          sessionStorage.setItem("kalender-username", username);
          userColor = getRandomColor();
        }
      });

      // Wiederherstellen, falls Seite neu geladen
      const savedName = sessionStorage.getItem("kalender-username");
      if (savedName) {
        username = savedName;
        nameInput.value = savedName;
        userColor = getRandomColor(); // neue Farbe bei neuem Login
      }

      // Kalender bauen
      createCalendar("juni", "Juni", 30);
      createCalendar("juli", "Juli", 31);
    });
  </script>
</head>
<body>
  <h1>Urlaubsabstimmung – Juni & Juli</h1>
  <input type="text" id="nameInput" placeholder="Dein Name hier eingeben" />
  <div id="calendars"></div>
</body>
</html>
